name: Customizer
permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  sysinfo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y neofetch nodejs npm unzip expect jq
          echo "#### Dependencies installed ####"

      - name: Run Neofetch
        run: neofetch

      - name: Install Ngrok Agent
        run: |
          curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc | tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | tee /etc/apt/sources.list.d/ngrok.list
          apt-get update
          apt-get install -y ngrok
          echo "#### Ngrok installed via apt ####"

      - name: Add Ngrok Auth Token
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: ngrok config add-authtoken "$NGROK_AUTH_TOKEN"

      - name: Install and Start Server
        run: |
          git clone https://github.com/redhat-developer/red-hat-developer-hub-customization-provider.git
          cd red-hat-developer-hub-customization-provider
          npm install
          npm start &           # Launch in background
          echo "Waiting for server to become available..."
          sleep 10              # Adjust as needed or replace with wait-on

      - name: Start Ngrok Tunnel
        uses: luisboto/ngrok-tunnel-action@v0.1.7.2
        with:
          timeout: 5h
          port: 8080            # Assuming your app is listening on port 8080
          ngrok_authtoken: ${{ secrets.NGROK_AUTH_TOKEN }}
          tunnel_type: http
          save_url_to_filename: ngrok_url.txt

      - name: Display Ngrok URL
        run: |
          echo "Ngrok URL:"
          cat ngrok_url.txt

      - name: Heartbeat and Keep Runner Alive
        run: |
          curl -v localhost:8080
          echo "End Test"
          echo "Keeping the runner alive for 5 hours..."
          sleep 18000